name: Deploy to Kubernetes

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
    
    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig
    
    - name: Deploy to dev environment
      run: |
        kubectl apply -k infra/k8s/overlays/dev
    
    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/gateway-service -n autorepairshop-dev
        kubectl rollout status deployment/workorder-service -n autorepairshop-dev
        kubectl rollout status deployment/customer-service -n autorepairshop-dev
    
    - name: Run smoke tests
      run: |
        kubectl run smoke-test --image=curlimages/curl:latest --rm -i --restart=Never -- \
          curl -f http://gateway-service.autorepairshop-dev.svc.cluster.local:8080/actuator/health
    
    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'Deployment to dev environment: ${{ job.status }}'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
